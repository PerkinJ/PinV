{"version":3,"sources":["../../../../src/components/modules/ChordDiagram/ChordDiagram.js"],"names":["d3","ChordDiagram","props","handleArcMouseOver","e","d","setState","activeIndex","index","tooltip","x","clientX","y","clientY","child","value","show","handleChordMouseOver","window","event","contentArr","source","target","key1","state","nameByIndex","get","value1","key2","value2","push","key","content","handleMouseOut","componentDidMount","indexByName","Map","n","name","substring","lastIndexOf","data","forEach","has","set","render","width","height","padAngle","interactive","outerRadius","innerRadius","color","scaleOrdinal","schemeCategory20","chord","sortSubgroups","descending","sortChords","ribbon","radius","arc","imports","map","matrix","row","i","chordData","chordDiagram","el","groups","angle","startAngle","endAngle","rgb","darker","Math","PI","ribbons","opacity","defaultProps","arcWidth","padding"],"mappings":"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","file":"ChordDiagram.js","sourcesContent":["import { h, Component } from 'preact'\n// import { legendColor } from 'd3-svg-legend'\nimport * as d3 from 'd3'\nimport styles from './index.css'\nimport Tooltip from '../../common/Tooltip'\nexport default class ChordDiagram extends Component {\n\tstatic defaultProps = {\n\t\twidth: 700,\n\t\theight: 700,\n\t\tarcWidth: 10,\t//外弧的宽度，最大不超过宽度/高度的1/3\n\t\tpadding: 10,\t\t// padding，最大不超过宽度/高度的1/3\n\t\tpadAngle: 0.03,   // 弦的间隔，[0,0.1]\n\t\tinteractive: true\n\t}\n\tconstructor(props) {\n\t\tsuper(props)\n\t\tthis.state = {\n\t\t\tactiveIndex: -1,  // 默认为-1，表示全部显示\n\t\t\tcontent:'',\n\t\t\ttooltip:{}\n\t\t}\n\t}\n\t// 处理鼠标移到弧上\n\thandleArcMouseOver = (e, d) => {\n\t\tthis.setState({\n\t\t\tactiveIndex: d.index,\n\t\t\ttooltip: {\n\t\t\t\tx: e.clientX + 20,\n\t\t\t\ty: e.clientY,\n\t\t\t\tchild: d.value,\n\t\t\t\tshow: true\n\t\t\t}\n\t\t})\n\t}\n\n\t// 处理鼠标移到任意弦上\n\thandleChordMouseOver = (e, d) => {\n\t\te = e || window.event\n\t\t// // 比较source跟target的value值大小，从而设置activeIndex\n\t\tlet activeIndex = -1, contentArr = []\n\t\tif (d.source.value >= d.target.value) {\n\t\t\tactiveIndex = d.source.index\n\t\t} else {\n\t\t\tactiveIndex = d.target.index\n\t\t}\n\t\tlet key1 = this.state.nameByIndex.get(d.target.index),\n\t\t\tvalue1 = ` ${d.target.value}`,\n\t\t\tkey2 = this.state.nameByIndex.get(d.source.index),\n\t\t\tvalue2 = ` ${d.source.value}`\n\n\t\tcontentArr.push({ key: key1, value: value1 }, { key: key2, value: value2 })\n\t\tlet child = `source:${key1},value:${value1}\\ntarget:${key2},value:${value2}`\n\t\tthis.setState({\n\t\t\tactiveIndex,\n\t\t\tcontentArr,\n\t\t\tcontent:'',\n\t\t\ttooltip: {\n\t\t\t\tx: e.clientX + 20,\n\t\t\t\ty: e.clientY,\n\t\t\t\tchild,\n\t\t\t\tshow: true\n\t\t\t}\n\t\t})\n\t}\n\n\thandleMouseOut = () => {\n\t\tthis.setState({\n\t\t\t// contentArr:[],\n\t\t\t// content:'',\n\t\t\tactiveIndex: -1,\n\t\t\ttooltip: {\n\t\t\t\tx: 0,\n\t\t\t\ty: 0,\n\t\t\t\tchild: '',\n\t\t\t\tshow: false\n\t\t\t}\n\t\t})\n\t}\n\tcomponentDidMount(){\n\t\tlet indexByName = new Map(),\n\t\t\tnameByIndex = new Map(),\n\t\t\tn = 0\n\t\t// Returns the Flare package name for the given class name.\n\t\tfunction name(name) {\n\t\t\treturn name.substring(0, name.lastIndexOf(\".\")).substring(6)\n\t\t}\n\t\t// Compute a unique index for each package name.\n\t\tthis.props.data.forEach(d => {\n\t\t\tif (!indexByName.has(d = name(d.name))) {\n\t\t\t\tnameByIndex.set(n, d)\n\t\t\t\tindexByName.set(d, n++)\n\t\t\t}\n\t\t})\n\t\tthis.setState({nameByIndex})\n\t}\n\trender({ width, height,padAngle,interactive }, { activeIndex,tooltip }) {\n\t\tlet outerRadius = width / 2,\n\t\t\tinnerRadius = outerRadius - 150\n\n\t\tlet color = d3.scaleOrdinal(d3.schemeCategory20)\n\n\t\tlet chord = d3.chord()\n\t\t\t.padAngle(padAngle)\n\t\t\t.sortSubgroups(d3.descending)\n\t\t\t.sortChords(d3.descending)\n\n\t\tlet ribbon = d3.ribbon().radius(innerRadius)\n\n\t\tlet arc = d3.arc()\n\t\t\t.innerRadius(innerRadius)\n\t\t\t.outerRadius(innerRadius + 20)\n\t\tlet imports = this.props.data\n\n\t\tlet indexByName = d3.map(),\n\t\t\tnameByIndex = d3.map(),\n\t\t\tmatrix = [],\n\t\t\tn = 0\n\n\t\t// Returns the Flare package name for the given class name.\n\t\tfunction name(name) {\n\t\t\treturn name.substring(0, name.lastIndexOf(\".\")).substring(6)\n\t\t}\n\t\t// Compute a unique index for each package name.\n\t\timports.forEach(d => {\n\t\t\tif (!indexByName.has(d = name(d.name))) {\n\t\t\t\tnameByIndex.set(n, d)\n\t\t\t\tindexByName.set(d, n++)\n\t\t\t}\n\t\t})\n\t\t// Construct a square matrix counting package imports.\n\t\timports.forEach(d => {\n\t\t\tlet source = indexByName.get(name(d.name)),\n\t\t\t\trow = matrix[source]\n\t\t\tif (!row) {\n\t\t\t\trow = matrix[source] = []\n\t\t\t\tfor (let i = -1; ++i < n;) row[i] = 0\n\t\t\t}\n\t\t\td.imports.forEach(d => row[indexByName.get(name(d))]++)\n\t\t})\n\t\tlet chordData = chord(matrix)\n\t\treturn (\n\t\t\t<div ref={el => this.chordDiagram = el}>\n\t\t\t\t<Tooltip {...tooltip} />\n\t\t\t\t<svg ref={el => this.chordDiagram = el} width={width} height={height} >\n\t\t\t\t\t<g transform={`translate(${outerRadius},${outerRadius})`}>\n\t\t\t\t\t\t<g class={styles.groups}>\n\t\t\t\t\t\t\t{chordData.groups.map((d, index) => {\n\t\t\t\t\t\t\t\td.angle = (d.startAngle + d.endAngle) / 2\n\t\t\t\t\t\t\t\treturn (\n\t\t\t\t\t\t\t\t\t<g key={index}>\n\t\t\t\t\t\t\t\t\t\t<path d={arc(d)}\n\t\t\t\t\t\t\t\t\t\t\tonMouseOver={interactive ? (e) => this.handleArcMouseOver(e, d) : null}\n\t\t\t\t\t\t\t\t\t\t\tonMouseMove={interactive ? (e) => this.handleArcMouseOver(e, d) : null}\n\t\t\t\t\t\t\t\t\t\t\tonMouseOut={interactive ? this.handleMouseOut : null}\n\t\t\t\t\t\t\t\t\t\t\tfill={color(d.index)}\n\t\t\t\t\t\t\t\t\t\t\tstroke={d3.rgb(color(d.index)).darker()}\n\t\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t\t\t<text\n\t\t\t\t\t\t\t\t\t\t\ttransform={\"rotate(\" + (d.angle * 180 / Math.PI - 90) + \")\"\n\t\t\t\t\t\t\t\t\t\t\t\t+ \"translate(\" + (innerRadius + 26) + \")\"\n\t\t\t\t\t\t\t\t\t\t\t\t+ (d.angle > Math.PI ? \"rotate(180)\" : \"\")}\n\t\t\t\t\t\t\t\t\t\t\tdy=\".2em\"\n\t\t\t\t\t\t\t\t\t\t\ttext-anchor={d.angle > Math.PI ? \"end\" : null}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t{nameByIndex.get(d.index)}\n\t\t\t\t\t\t\t\t\t\t</text>\n\t\t\t\t\t\t\t\t\t</g>\n\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</g>\n\t\t\t\t\t\t<g class={styles.ribbons} >\n\t\t\t\t\t\t\t{chordData.map((d, index) =>\n\t\t\t\t\t\t\t\t<g key={index}>\n\t\t\t\t\t\t\t\t\t<path\n\t\t\t\t\t\t\t\t\t\tonMouseOver={interactive ? (e) => this.handleChordMouseOver(e, d) : null}\n\t\t\t\t\t\t\t\t\t\tonMouseMove={interactive ? (e) => this.handleChordMouseOver(e, d) : null}\n\t\t\t\t\t\t\t\t\t\tonMouseOut={interactive ? this.handleMouseOut : null}\n\t\t\t\t\t\t\t\t\t\td={ribbon(d)}\n\t\t\t\t\t\t\t\t\t\tstyle={{ opacity: activeIndex !== -1 && d.source.index !== activeIndex && d.target.index !== activeIndex ? 0 : 1 }}\n\t\t\t\t\t\t\t\t\t\tfill={color(d.target.index)}\n\t\t\t\t\t\t\t\t\t\tstroke={d3.rgb(color(d.target.index)).darker()}\n\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t</g>\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</g>\n\t\t\t\t\t</g>\n\t\t\t\t</svg>\n\t\t\t</div>\n\t\t)\n\t}\n}\n"]}